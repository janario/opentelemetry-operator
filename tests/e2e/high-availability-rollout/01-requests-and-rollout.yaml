apiVersion: v1
kind: Pod
metadata:
  name: requests-and-rollout
spec:
  securityContext:
    runAsUser: 0
  serviceAccountName: requests-and-rollout
  containers:
    - name: siege
      image: bitnami/kubectl
      env:
        - name: K8S_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: COL_MODE
          value: ($mode)
      command:
        - bash
        - -ec
        - |
          apt update
          apt install -y siege
          
          echo "limit = 3000" > ~/.siegerc
          
          # wait[10s]
          # rollout > wait[rollout] > wait[20s] *5=100s
          sleep 10 && \
            kubectl -n ${K8S_NAMESPACE} rollout restart ${COL_MODE}/ha-collector && kubectl -n ${K8S_NAMESPACE} rollout status ${COL_MODE}/ha-collector && sleep 20 && \
            kubectl -n ${K8S_NAMESPACE} rollout restart ${COL_MODE}/ha-collector && kubectl -n ${K8S_NAMESPACE} rollout status ${COL_MODE}/ha-collector && sleep 20 && \
            kubectl -n ${K8S_NAMESPACE} rollout restart ${COL_MODE}/ha-collector && kubectl -n ${K8S_NAMESPACE} rollout status ${COL_MODE}/ha-collector && sleep 20 && \
            kubectl -n ${K8S_NAMESPACE} rollout restart ${COL_MODE}/ha-collector && kubectl -n ${K8S_NAMESPACE} rollout status ${COL_MODE}/ha-collector && sleep 20 && \
            kubectl -n ${K8S_NAMESPACE} rollout restart ${COL_MODE}/ha-collector && kubectl -n ${K8S_NAMESPACE} rollout status ${COL_MODE}/ha-collector && sleep 20 \
          &
          
          echo "Starting siege"
          
          # Good case [without the rollout]
          # "transactions":			      576592,
          #	"availability":			      100.00,
          # 
          # Bad case
          # "transactions":			      196548,
          # "availability":			       99.46,
          siege -b -c 500 -t2m http://ha-collector.${K8S_NAMESPACE}:4318
