apiVersion: v1
kind: Pod
metadata:
  name: requests-and-rollout
spec:
  securityContext:
    runAsUser: 0
  serviceAccountName: requests-and-rollout
  containers:
    - name: siege
      image: bitnami/kubectl
      env:
        - name: K8S_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: COL_MODE
          value: ($mode)
      command:
        - bash
        - -ec
        - |
          apt update
          apt install -y siege
          
          sleep 5 \
            && kubectl -n ${K8S_NAMESPACE} rollout restart ${COL_MODE}/ha-collector && kubectl -n ${K8S_NAMESPACE} rollout status ${COL_MODE}/ha-collector && sleep 10 \
            && kubectl -n ${K8S_NAMESPACE} rollout restart ${COL_MODE}/ha-collector && kubectl -n ${K8S_NAMESPACE} rollout status ${COL_MODE}/ha-collector && sleep 10 \
            && kubectl -n ${K8S_NAMESPACE} rollout restart ${COL_MODE}/ha-collector && kubectl -n ${K8S_NAMESPACE} rollout status ${COL_MODE}/ha-collector && sleep 10 \
            && kubectl -n ${K8S_NAMESPACE} rollout restart ${COL_MODE}/ha-collector && kubectl -n ${K8S_NAMESPACE} rollout status ${COL_MODE}/ha-collector && sleep 10 \
            && kubectl -n ${K8S_NAMESPACE} rollout restart ${COL_MODE}/ha-collector && kubectl -n ${K8S_NAMESPACE} rollout status ${COL_MODE}/ha-collector && sleep 10 \
          &
          echo "Starting siege"
          siege -d1 -c 30 -t60s http://ha-collector.${K8S_NAMESPACE}:4318
