# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  creationTimestamp: null
  name: high-availability-rollout
spec:
  bindings:
    - name: mode
      value: deployment
#      value: statefulset
  steps:
    - name: step-00
      try:
        - apply:
            file: 00-install-collector.yaml
            template: true
        - apply:
            file: 00-prepare-rbac.yaml
            template: true
        - assert: # wait collector pods to be running
            resource:
              apiVersion: v1
              kind: Pod
              metadata:
                labels:
                  app.kubernetes.io/name: collector-collector
              status:
                phase: Running

    - name: step-01
      try:
        - apply:
            file: 01-requests-and-rollout.yaml
            template: true
        - assert: # wait test pod to be running
            resource:
              apiVersion: v1
              kind: Pod
              metadata:
                name: requests-and-rollout
              status:
                phase: Running
        - command:
            timeout: 5m
            entrypoint: kubectl
            args:
              - -n
              - ${NAMESPACE}
              - logs
              - -c
              - siege
              - -f
              - requests-and-rollout
#        - sleep:
#            duration: 120s


